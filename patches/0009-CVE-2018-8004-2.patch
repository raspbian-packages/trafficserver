Description: Patch 2 of 4 for CVE-2018-8004
 There are multiple HTTP smuggling and cache poisoning issues when clients
 making malicious requests interact with ATS.
 This patch closes the connection when returning a 400 error response
Author: Bryan Call <bcall@apache.org>
Origin: upstream, https://github.com/apache/trafficserver/pull/3201
Applied-Upstream: https://github.com/apache/trafficserver/commit/9659d12a21cf1870c2790fdd5acab712ed87f16e
Reviewed-by: Jean Baptiste Favre <debian@jbfavre.org>
Last-Update: 2018-08-29
---
This patch header follows DEP-3: http://dep.debian.net/deps/dep3/
--- a/proxy/http/HttpTransact.cc
+++ b/proxy/http/HttpTransact.cc
@@ -8067,6 +8067,11 @@ HttpTransact::build_error_response(State
     s->client_info.keep_alive = HTTP_NO_KEEPALIVE;
   }
 
+  // If there is a parse error on reading the request it can leave reading the request stream in an undetermined state
+  if (status_code == HTTP_STATUS_BAD_REQUEST) {
+    s->client_info.keep_alive = HTTP_NO_KEEPALIVE;
+  }
+
   switch (status_code) {
   case HTTP_STATUS_BAD_REQUEST:
     SET_VIA_STRING(VIA_CLIENT_REQUEST, VIA_CLIENT_ERROR);
--- a/tests/gold_tests/headers/syntax.400.gold
+++ b/tests/gold_tests/headers/syntax.400.gold
@@ -1,4 +1,4 @@
 HTTP/1.1 400 Invalid HTTP Request
 Date: ``
-Connection: keep-alive
+Connection: close
 Server: ``
